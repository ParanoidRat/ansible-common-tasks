# Adds configuration to allow custom service to be accessed from pre-defined
# ipset
#
# Usage example
#
# - include_tasks: task_firewalld-allow-svc.yml
#   become: yes
#   vars:
#     allow_svc_port: "{{ item.port }}"
#     allow_svc_protocol: "{{ item.proto }}"
#     allow_svc_hosts: "{{ item.hosts }}"
#     allow_svc_comment: "{{ item.comment }}"
#   loop_control:
#     loop_var: allow_svc_item
#   with_items:
#     - comment: SYSLOG
#       port: 514
#       proto: udp
#       hosts:
#         - 192.168.0.1
#         - 192.168.0.2
#   tags: prime
#
---
- name: "Allow service :: {{ allow_svc_comment }}"
  firewalld:
    rich_rule: "rule family=ipv4 source address={{ item }} port port={{ allow_svc_port }} protocol={{ allow_svc_protocol }} accept"
    permanent: "{{ allow_svc_permanent | default(no)}}"
    timeout: "{{ allow_svc_timeout | default(omit) }}"
    state: "{{ allow_svc_state  | default(enabled) }}"
  with_items: "{{ allow_svc_hosts }}"
  loop_control:
    label: "{{ item }}"
  notify:
    - "{{ allow_svc_handler | default(omit) }}"

- name: "Restart firewall"
  service:
    name: firewalld
    state: restarted
    enabled: yes
