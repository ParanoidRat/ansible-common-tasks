# Expand temlates to target host and upon completion notify
# {{ expand_templates_handler }} if defined
#
#  Usage example
#
#   handlers:
#     - name: Restart service
#       debug:
#         msg: Service restarted
#
#   tasks:
#     - import_tasks: expand_templates.yml
#       vars:
#         expand_templates_handler: "Restart service"
#         expand_templates_list:
#           - src:   "/source/template.j2"
#             dest:  "/target/config.cfg"
#             owner: "user"
#             group: "group"
#             mode:  "u=rw,g=r,o=r"
#             validate: "/usr/bin/validate.sh %s"
#             backup: yes
#
---
# Create all destination folders
- name: Ensure template destinations exist
  file:
    path:     "{{ item.dest | dirname }}"
    owner:    "{{ item.owner }}"
    group:    "{{ item.group }}"
    mode:     "u=rwx,g=rx,o=rx"
    state:    directory
    recurse:  yes
  with_items: "{{ expand_templates_list }}"
  loop_control:
    label: "{{ item.dest | dirname }}"

# Go through template list and notify handler upon completion (if defined)
- name: Expand templates on target
  template:
    src:      "{{ item.src }}"
    dest:     "{{ item.dest }}"
    owner:    "{{ item.owner }}"
    group:    "{{ item.group }}"
    mode:     "{{ item.mode }}"
    validate: "{{ item.validate | default(omit) }}"
    backup:   "{{ item.backup }}"
  with_items: "{{ expand_templates_list }}"
  loop_control:
    label: "{{ item.src }}"
  notify: "{{ expand_templates_handler | default(omit) }}"
