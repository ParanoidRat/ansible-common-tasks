# Adds a local account to target and makes it part of sudoers
# through dedicated file at /etc/sudoers.d/
#
# Usage example
#
# - name: "Deployment account exists and configured"
#   hosts: all
#   tasks:
#   - import_tasks: tasks/task_add-sudo-account.yml
#     become: yes
#     vars:
#       sudo_account_name: deployer
#       sudo_account_uid: 1001
#       sudo_account_home_dir: /var/home/deployer
#       sudo_account_ssh_key: "./files/ssh-key-deployer.pub"
#   tags: sudo-account
#
---
- name: "Ensure account group exists"
  group:
    name: "{{ sudo_account_name }}"
    state: present

- name: "Get account info, if exists"
  getent:
    database: passwd
    key: "{{ sudo_account_name }}"
    fail_key: no

- name: "Create account, if doesn't exist"
  user:
    uid: "{{ sudo_account_uid | default(omit) }}"
    name: "{{ sudo_account_name }}"
    group: "{{ sudo_account_name }}"
    home: "{{ sudo_account_home_dir | default('/home/' + sudo_account_name) }}"
    state: present
    createhome: yes
  when: getent_passwd[sudo_account_name] | string == "None"

- name: "Place authorized keys for account"
  authorized_key:
    user: "{{ sudo_account_name }}"
    key: "{{ item }}"
  with_file:
  - "{{ sudo_account_ssh_key }}"

- name: "Ensure /etc/sudoers.d/ exists"
  file:
    path: /etc/sudoers.d
    owner: root
    group: root
    mode: "u=rwx,g=rx,o=rx"
    state: directory

- name: "Ensure /etc/sudoers.d/ referred in /etc/sudoers"
  lineinfile:
    dest: /etc/sudoers
    line: "#includedir /etc/sudoers.d"
    state: present
    validate: "/usr/sbin/visudo -cf %s"

- name: "Ensure sudoers.d has directives for account"
  copy:
    content: |
      #
      # This file was generated by Ansible
      #
      # It allows sudo execution without asking for password
      # for the account below
      #
      {{ sudo_account_name }} ALL=(ALL) NOPASSWD: ALL
    dest: "/etc/sudoers.d/{{ sudo_account_name }}"
    owner: root
    group: root
    mode: "u=r,g=r,o="
    validate: "/usr/sbin/visudo -cf %s"
