# Configures firewalld to SSH-only zone 'ssh-only' with allowed clietn IPs or
# CIDR blocks defined in 'ssh-allowed' ipset
#
# Usage example
#
#   tasks:
#   - import_tasks: task_firewalld-ssh-only.yml
#     become: yes
#
---
- name: "Disable and stop firewalld"
  service:
    name: firewalld
    state: stopped
    enabled: no

- name: "Delete firewalld config dirs"
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /etc/firewalld/zones
    - /etc/firewalld/ipsets

# Generate zone and ipset files for SSH-only access
- import_tasks: task_expand-templates.yml
  vars:
    expand_templates_list:
      - src: "templates/ssh-only.xml.j2"
        dest: "/etc/firewalld/zones/ssh-only.xml"
        owner: "root"
        group: "root"
        mode: "u=rw,g=r,o=r"

      - src: "templates/ssh-allowed.xml.j2"
        dest: "/etc/firewalld/ipsets/ssh-allowed.xml"
        owner: "root"
        group: "root"
        mode: "u=rw,g=r,o=r"

- name: "Make SSH-only zone the default"
  lineinfile:
    dest: /etc/firewalld/firewalld.conf
    regexp: '^DefaultZone=(.*)$'
    line: "DefaultZone=ssh-only"
    state: present

- name: "Enable and start firewalld"
  service:
    name: firewalld
    state: started
    enabled: yes
